{% extends 'base.html' %}

{% block title %} Aventure Planning {% endblock %}
{% block body %}

<h1>Adventure Planning</h1>

<h2>Search a city for top sights</h2>

  <form id="sights" method="get" action="/city">
    City: <input type="text" name="city" id="city" required>

    <input type="submit" id="sights" value="Submit">

    {% if session %}
      <input type="text" value="true" id="is_session" hidden >
    {% else %}
      <input type="text" value="false" id="is_session" hidden>
    {% endif %}

  </form>

  <p>
    <h3>Top Sights:</h3> <span id='top_sights'></span>
    <ul id='list_items'></ul>
  </p>


 <script>
  "use strict";
  let submitButton = document.querySelector("#sights");

  function showDetails(result) {
    console.log(result)
    // show message to user it was added

  }

  function addSight(param) {
    if (param.innerText === "Add sight to trip") {
      param.innerText = "Sight added";
    }
    let sight = document.querySelector(`a#${param.id}`);
    console.log(sight.innerText); //getting sight

    var trip = $(`select#${param.id}`).find(':selected').text();
    console.log(trip.trim()); //getting trip selected

    let formInputs = {'city': $("#city").val(),
                    'sight_name': sight.innerText,
                    'trip': trip.trim(),
                     }

    $.post("/add-sights", formInputs, showDetails);
  }

  // once click, function that adds to details page


  function showResults(result) {
    console.log(result)
    console.log(result[5])

    let trips = result[5]
    // result[0]=top_sights
    // result[1]=lat_long
    // result[2]=coordinates
    // result[3]=image_url
    // result[4]=sight_url
    // result[5]=added trips


    
    for (let i = 0; i < result[0].length; i++){
        $('#list_items').append(`<li><img src=${result[3][i]} style="width:100px;height:100px"> <br> 
        <a id=addSight_${i} href=${result[4][i]} target="_blank">${result[0][i]}</a></li>`)

            let session = document.querySelector('#is_session');
            if (session.value === "true") {

              let trip_strings = []

                for (let j = 0; j < trips.length; j++) {
                    trip_strings.push(`<option id=addSight_${j} class=addSight_${j} value=addSight_${j}> ${trips[j]} </option>`)
                  }

              
              $('#list_items').append(`<form><select id=addSight_${i} name="add-to-trip")>
                ${trip_strings}
                  </select></form>

                <button id=addSight_${i} class='addSightText' onClick="addSight(this); this.onclick=null; this.diabled= true">Add sight to trip</button><br><br>`)
            }
    }

    let map = new google.maps.Map(document.querySelector('#map'), {
      center: result[1], 
      zoom: 8,
    })
    for (let i = 0; i < result[2].length; i++){
      let marker = new google.maps.Marker({
        position: new google.maps.LatLng(result[2][i]["latitude"],result[2][i]["longitude"]),
        map: map,
      })

      google.maps.event.addListener(marker,'click', function() {
          map.setZoom(14);
          map.setCenter(marker.getPosition());
          });
        

    // Construct a new InfoWindow.
      let infoWindow = new google.maps.InfoWindow({
        content: (`${result[0][i]}`)
      });

      // Opens the InfoWindow when marker is clicked.
      marker.addListener('click', function() {
        infoWindow.open(map, marker);
        });
    }
  }

  function submitCity(evt) {
    evt.preventDefault();
    let formInputs = {'city': $("#city").val()}
    
    $.get("/city", formInputs, showResults);
  }

  submitButton.addEventListener("submit", submitCity);

</script> 

<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>


<style type="text/css">
    html, body { height: 80%; margin: 0; padding: 0; }
    #map { height: 80%; }
  </style>

<div id="map"></div>

{% endblock %}